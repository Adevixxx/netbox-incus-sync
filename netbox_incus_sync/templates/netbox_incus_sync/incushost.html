{% extends 'generic/object.html' %}
{% load helpers %}
{% load plugins %}

{% block breadcrumbs %}
<li class="breadcrumb-item">
    <a href="{% url 'plugins:netbox_incus_sync:incushost_list' %}">Incus Hosts</a>
</li>
<li class="breadcrumb-item active">{{ object.name }}</li>
{% endblock breadcrumbs %}

{% block extra_controls %}
<button type="button" class="btn btn-sm btn-outline-primary" id="test-connection-btn" title="Test Connection">
    <i class="mdi mdi-connection"></i> Test Connection
</button>
{% endblock extra_controls %}

{% block content %}
<div class="row mb-3">
    <div class="col-md-6">
        <div class="card">
            <h5 class="card-header">General</h5>
            <div class="card-body">
                <table class="table table-hover attr-table">
                    <tr>
                        <th scope="row">Name</th>
                        <td>{{ object.name }}</td>
                    </tr>
                    <tr>
                        <th scope="row">Connection Type</th>
                        <td>{{ object.get_connection_type_display }}</td>
                    </tr>
                    <tr>
                        <th scope="row">Connection URL</th>
                        <td><code>{{ object.connection_url }}</code></td>
                    </tr>
                    <tr>
                        <th scope="row">Enabled</th>
                        <td>
                            {% if object.enabled %}
                            <span class="badge bg-success">Yes</span>
                            {% else %}
                            <span class="badge bg-danger">No</span>
                            {% endif %}
                        </td>
                    </tr>
                </table>
            </div>
        </div>

        {% if connection_status %}
        <div class="card mt-3">
            <h5 class="card-header">Connection Status</h5>
            <div class="card-body">
                <table class="table table-hover attr-table">
                    <tr>
                        <th scope="row">Status</th>
                        <td>
                            {% if connection_status.success %}
                            <span class="badge bg-success">Connected</span>
                            {% else %}
                            <span class="badge bg-danger">Failed</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% if connection_status.success %}
                    <tr>
                        <th scope="row">Server Name</th>
                        <td>{{ connection_status.server_name }}</td>
                    </tr>
                    <tr>
                        <th scope="row">Version</th>
                        <td>{{ connection_status.version }}</td>
                    </tr>
                    <tr>
                        <th scope="row">Cluster Mode</th>
                        <td>
                            {% if connection_status.cluster_enabled %}
                            <span class="badge bg-info">
                                <i class="mdi mdi-server-network"></i>
                                Cluster ({{ connection_status.cluster_members }} nodes)
                            </span>
                            <br>
                            <small class="text-muted">
                                A NetBox Cluster will be created automatically during sync.
                            </small>
                            {% else %}
                            <span class="badge bg-secondary">Standalone</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <th scope="row">Error</th>
                        <td class="text-danger">{{ connection_status.message }}</td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="col-md-6">
        <div class="card">
            <h5 class="card-header">NetBox Association</h5>
            <div class="card-body">
                <table class="table table-hover attr-table">
                    <tr>
                        <th scope="row">Default Cluster</th>
                        <td>
                            {% if object.default_cluster %}
                            <a href="{{ object.default_cluster.get_absolute_url }}">
                                {{ object.default_cluster }}
                            </a>
                            {% else %}
                            <span class="text-muted">Auto (created from Incus if cluster mode)</span>
                            {% endif %}
                        </td>
                    </tr>
                </table>
                <div class="alert alert-info mt-3 mb-0">
                    <i class="mdi mdi-information-outline"></i>
                    <strong>Cluster behavior:</strong>
                    <ul class="mb-0 mt-2">
                        <li>If Incus is in <strong>cluster mode</strong>: a NetBox Cluster is created automatically</li>
                        <li>If Incus is <strong>standalone</strong>: VMs are created without a cluster (unless you set a
                            default cluster above)</li>
                    </ul>
                </div>
            </div>
        </div>

        {% if object.connection_type == 'https' %}
        <div class="card mt-3">
            <h5 class="card-header">TLS Certificates</h5>
            <div class="card-body">
                <table class="table table-hover attr-table">
                    <tr>
                        <th scope="row">Client Certificate</th>
                        <td><code>{{ object.client_cert_path }}</code></td>
                    </tr>
                    <tr>
                        <th scope="row">Private Key</th>
                        <td><code>{{ object.client_key_path }}</code></td>
                    </tr>
                    <tr>
                        <th scope="row">CA Certificate</th>
                        <td>
                            {% if object.ca_cert_path %}
                            <code>{{ object.ca_cert_path }}</code>
                            {% else %}
                            <span class="text-muted">Not defined</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">Verify SSL</th>
                        <td>
                            {% if object.verify_ssl %}
                            <span class="badge bg-success">Yes</span>
                            {% else %}
                            <span class="badge bg-warning">No</span>
                            {% endif %}
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        {% endif %}

        {% include 'inc/panels/tags.html' %}
    </div>
</div>
{% endblock content %}

{% block javascript %}
{{ block.super }}
<script>
    document.getElementById('test-connection-btn').addEventListener('click', function (e) {
        e.preventDefault();
        const btn = this;
        const originalHtml = btn.innerHTML;

        btn.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Testing...';
        btn.disabled = true;

        fetch('{% url "plugins:netbox_incus_sync:incushost_test_connection" pk=object.pk %}')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let msg = `Connected to ${data.data.server_name || 'Incus'} v${data.data.version || '?'}`;
                    if (data.data.cluster_enabled) {
                        msg += `\nCluster mode: ${data.data.cluster_members} nodes`;
                    } else {
                        msg += `\nStandalone mode`;
                    }
                    if (data.data.instances_count !== undefined) {
                        msg += `\nInstances: ${data.data.instances_count}`;
                    }
                    if (data.data.storage_pools && data.data.storage_pools.length > 0) {
                        msg += `\nStorage pools: ${data.data.storage_pools.join(', ')}`;
                    }
                    if (data.data.networks && data.data.networks.length > 0) {
                        msg += `\nManaged networks: ${data.data.networks.join(', ')}`;
                    }
                    alert('✅ Connection successful!\n\n' + msg);
                } else {
                    alert('❌ Connection failed:\n\n' + data.message);
                }
            })
            .catch(error => {
                alert('❌ Error: ' + error);
            })
            .finally(() => {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            });
    });
</script>
{% endblock javascript %}